---
title: "ETF Portfolio Simulation Dashboard"
output: 
  flexdashboard::flex_dashboard:
    theme:
      version: 4
      bootswatch: minty
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(shinyWidgets)
library(shinyjs)

# Core
library(tidyverse)
library(tidyquant)
library(data.table)
library(tidytable)
library(scales)

# Interactive Visualizations
library(plotly)
```

```{r}
# Load data
data <- fread("data/tidied/full_data.csv") %>% 
  tidytable::mutate(date = as_date(date))
```

Page 1
===================================== 

Column {.sidebar}
-----------------------------------------------------------------------
### Danh mục:
```{r}
useShinyjs(rmd = TRUE)

# Input để chọn ETF 1

div(style = "display: flex;",
    pickerInput(
      inputId = "picker_etf1",
      label   = "ETF 1:",
      choices = toupper(unique(data$symbol)),
      selected = "VN30",
      multiple = FALSE),
    numericInput(
      inputId = "weight_etf1",
      label = "Tỷ trọng:",
      value = 0.5,
      min = 0,
      max = 1,
      step = 0.1)
    
    )

    
# Input để chọn ETF 2
div(style = "display: flex;",
    
    pickerInput(
      inputId = "picker_etf2",
      label   = "ETF 2:",
      choices = toupper(unique(data$symbol)),
      selected = "MIDCAP",
      multiple = FALSE),
    
    numericInput(
      inputId = "weight_etf2",
      label = "Tỷ trọng:",
      value = 0.5,
      min = 0,
      max = 1,
      step = 0.1
      )
    )
    

output$picker_etf1_value <- renderPrint(input$picker_etf1)
textOutput(outputId = "picker_etf1_value")

output$picker_etf1_weight <- renderPrint(input$weight_etf1)
textOutput(outputId = "picker_etf1_weight")


output$picker_etf2_value <- renderPrint(input$picker_etf2)
textOutput(outputId = "picker_etf2_value")
output$picker_etf2_weight <- renderPrint(input$weight_etf2)
textOutput(outputId = "picker_etf2_weight")

```

### So sánh với

```{r}

# picker_etf de so sanh voi cac quy ETF khac

pickerInput(
  inputId  = "picker_etf",
  label    = h4("Các ETF:"),
  choices  = toupper(unique(data$symbol)),
  selected = "VN30",
  multiple = TRUE,
  options  = list(`actions-box`          = TRUE,
                  size                   = 10,
                  `selected-text-format` = "ETF")
)

output$picker_etf_values <- renderPrint(input$picker_etf)
textOutput(outputId = "picker_etf_values")
```


```{r}
# Apply Button:
actionButton(inputId = "simulate", label = "Apply", icon = icon("play"))

# Reset Button:
actionButton(inputId = "reset_simulate", label = "Reset", icon = icon("sync"))

observeEvent(eventExpr = input$reset_simulate, handlerExpr = {
  
  updatePickerInput(
    session  = session,
    inputId  = "picker_etf",
    selected = "VN30")
  
  # Delay
  delay(ms = 80, expr = {
    click(id = "simulate")
  })
  
})
```

```{r}
# Sau khi click vào Apply thì lọc data theo tên của Input picker_etf

# 
# data_filtered <- data %>%
#   filter(symbol %in% c("vn30", "midcap"))


data_tbl <- eventReactive(

  eventExpr = input$simulate,

  valueExpr = {

    # 1. Thiết lập tỷ trọng ETF
    # Set thẳng tỷ trọng dựa theo symbol
    # Symbol:  input$picker_etf1 + input$picker_etf2
    # Weights: input$weight_etf1 + input$weight_etf2
    weights_df <- tibble(symbol = c("vn30", "midcap"),
                         weights = c(0.5, 0.5))
    
    # 2. Lập danh mục
    portfolio <- data %>%
      
      # Filter dựa theo symbol
      # Symbol: input$picker_etf1 + input$picker_etf2
      tidytable::filter(symbol %in% c("vn30", "midcap")) %>% 
      
      # Tính toán danh mục
      # (?) Có nên tạo một input rebalance_on không?
      tq_portfolio(assets_col   = symbol,
                   returns_col  = returns,
                   weights      = weights_df,
                   col_rename   = "returns",
                   rebalance_on = "years") %>%   
      
      tidytable::mutate(symbol = "portfolio") 
    
    
    # 3. Gộp dữ liệu để so sánh portfolio với ETF
    # Symbol so sánh: input$picker_etf 
    data_combined <- portfolio %>% 
      bind_rows(data %>% 
                  tidytable::filter(symbol %in% c("vn30")))
    

    return(data_combined)

    },

  ignoreNULL = FALSE

  )

reactive(data_tbl())

```

Row
-----------------------------------------------------------------------
### Cumulative Returns Plot
    
```{r}
# Chuẩn bị dữ liệu:

# data_filtered %>%
#   tidytable::mutate(growth = cumprod(1 + returns), .by = symbol) %>%
# 
#   tidytable::mutate(label_txt = str_glue("Date: {date}
#                                            ETF: {toupper(symbol)}
#                                            Lợi nhuận tích lũy: {scales::percent(growth - 1, accuracy = 0.1)}")) 


cum_ret <- reactive({

  data_tbl() %>%
    tidytable::mutate(growth = cumprod(1 + returns), .by = symbol) %>%
    tidytable::mutate(label_txt = str_glue("Date: {date}
                                           ETF: {toupper(symbol)}
                                           Lợi nhuận tích lũy: {scales::percent(growth - 1, accuracy = 0.1)}"))
})


# Output:
output$plotly_cum_ret <- renderPlotly({
  
  p1 <- cum_ret() %>%

    ggplot(aes(x = date,
               y = growth,
               color = symbol)) + theme_tq() +

    geom_line(size = 0.7) +
    geom_point(aes(text = label_txt), size = 0.5) +

    expand_limits(y = 0.5) +
    scale_x_date(breaks = scales::pretty_breaks(n = 10)) +

    geom_hline(yintercept = 1,
               linetype   = "dashed",
               color      = "#7A7574") +

    labs(x = "",
         y = "")
  
  ggplotly(p1, tooltip = "text")
  
  })

# Plot
plotlyOutput(outputId = "plotly_cum_ret")
```
    

   
Page 2 {data-icon="fa-hashtag"}
=====================================     


Column {.sidebar}
-----------------------------------------------------------------------

```{r}
useShinyjs(rmd = TRUE)

# Input để chọn ETF
pickerInput(
  inputId = "picker_etf",
  label   = h4("TEST ETF:"),
  choices = toupper(unique(data$symbol)),
  selected = "E1VFVN30",
  multiple = FALSE
)

```
